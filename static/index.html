<!DOCTYPE html>
<html lang="en">
  <head>
    <title>IPsaur</title>
    <meta charset="UTF-8" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/client.css" />
    <script src="/client.js"></script>
  </head>

  <body>
    <img id="logo" class="bounce" style="position: absolute" src="logo.png" />
    <div style="padding-left: 60px" class="box menu">
      <span class="bold"><span style="font-size: 20px">IPsaur</span></span>
      <div class="bold">
        <span id="results_to_clipboard"
          >[<a><img src="clipboard.png" width="18px" />To Clipboard</a>]</span
        >
        <span
          >[<a href="javascript:toggleShareBlock()"
            ><img src="share.png" width="18px" />Share results</a
          >]</span
        >
        <span
          >[<a href=""><img src="github.png" width="18px" /> Github</a>]</span
        >
        <span
          >[<a href=""><img src="heart.png" width="18px" />Donate</a>]</span
        >
      </div>
    </div>
    <div id="share_block" style="display: none" class="box">
      The test results will be shared.<br />
      Please read and accept the data sharing terms and conditions below.<br />
      <div id="data_sharing_conditions">
        Test results will be stored on our servers.<br /><br />
        Data will be automatically removed from our servers after 30 days.<br /><br />
        You will receive the DeleteKey to delete the shared data. Please keep it
        secure and don't share with others. You won't be able to recover the
        DeleteKey if it is lost.<br /><br />
        [<input
          id="share_accepted"
          type="checkbox"
          onchange="shareAccepted(this.checked)"
        />]<label for="share_accepted">
          I accept the data sharing terms and conditions.</label
        >
      </div>
      <div id="do_share" style="display: none">
        Comment (optional):<br /><textarea
          style="
            width: 100%;
            height: 5em;
            background-color: #111;
            color: #ddd;
            font-size: 14px;
          "
        ></textarea
        ><br />
        [<a href="javascript:doShare()">Give me the URL and password</a
        >]<br /><br />
      </div>
      <div id="share_data" style="display: none">
        <br />
        Url:
        <span id="share_url" class="underline" style="overflow-wrap: anywhere"
          >https://share.url/s/base64hash</span
        >
        <span id="share_url_a">[<a>Clip</a>]</span><br />
        DeleteKey:
        <span id="share_password" class="grey" style="overflow-wrap: anywhere"
          >P@$$w0rd</span
        >
        <span id="share_password_a">[<a>Clip</a>]</span><br />
      </div>
    </div>
    <div id="error_block" class="box" style="display: none"></div>
    <div id="terminal" class="box terminal"></div>
    <div id="nettest" class="box">
      <span class="magenta bold">Network Bandwidth Test</span><br />
      <div class="terminal">
        Round-Trip Time: <span id="rtt_primary"></span>
      </div>
      <div class="terminal">Download Speed: <span id="dl_primary"></span></div>
      <div class="terminal">Upload Speed: <span id="ul_primary"></span></div>
    </div>
    <div id="test_timestamp" class="box"></div>
  </body>

  <script>
    async function addTextToClipboard(id) {
      const element = document.querySelector("#" + id);
      await navigator.clipboard.writeText(element.innerHTML);
    }
    const test_results = {
      ip: {},
      nettest: {},
      browsertimeutc: "",
      browsertimelocal: "",
    };
    document
      .getElementById("results_to_clipboard")
      .addEventListener(
        "click",
        async () =>
          await navigator.clipboard.writeText(JSON.stringify(test_results))
      );
    document
      .getElementById("share_url_a")
      .addEventListener(
        "click",
        async () => await addTextToClipboard("share_url")
      );
    document
      .getElementById("share_password_a")
      .addEventListener(
        "click",
        async () => await addTextToClipboard("share_password")
      );

    window.addEventListener("load", async () => {
      const terminal = document.getElementById("terminal");
      try {
        const rsp = await fetch("/json");
        const ip_data = await rsp.json();
        test_results.ip = ip_data;
        let text = `\x1b[1;35mIP Address\x1b[0m  \x1b[1;4;32m${ip_data.ip}\x1b[0m\n`;
        text += `\x1b[1;33mUser agent\x1b[0m  ${ip_data.ua}\n`;

        if (ip_data.ip_details.asn || ip_data.ip_details.city) {
          text += "\n\x1b[1;36mIP Geolocation Details\x1b[0m Provided by: ";
          if (ip_data.providers.dbip) text += "DB-IP (https://db-ip.com) ";
          if (ip_data.providers.maxmind) {
            text += "MaxMind (https://www.maxmind.com)";
          }
          text += "\n";

          if (ip_data.ip_details.asn) {
            text += `  Provider: ${ip_data.ip_details.asn.autonomous_system_organization} (AS${ip_data.ip_details.asn?.autonomous_system_number})\n`;
          }
          if (ip_data.ip_details.city) {
            text += `  Country:  ${ip_data.ip_details.city.continent?.code} ${ip_data.ip_details.city.country?.iso_code} - ${ip_data.ip_details.city.country?.names.en}\n`;
            text += `  City:     ${ip_data.ip_details.city.city?.names.en}\n`;
          }
        }
        text +=
          "\nServer time: " + new Date(ip_data.servertime).toUTCString() + "\n";
        printTextEl(terminal, text);
        test_results.nettest = await testBandwidth("primary");
        const ts = new Date();
        const e = document.getElementById("test_timestamp");
        if (e) e.innerText = "Browser time: " + ts.toString();
        test_results.browsertimeutc = ts.toJSON();
        test_results.browsertimelocal = ts.toString();
      } catch (err) {
        const err_block = document.getElementById("error_block") || terminal;
        err_block.style.display = "block";
        printTextEl(
          err_block,
          `\x1b[1mOoops... There is something happened in IPsaur's land.\x1b[0m\n\n\x1b[1;31mError details:\x1b[0m\n${err.stack}`
        );
      }
    });
  </script>
</html>
